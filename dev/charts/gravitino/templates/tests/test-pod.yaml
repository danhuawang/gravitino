apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-test-pod"
  annotations:
    "helm.sh/hook": test
spec:
  serviceAccountName: {{ include "gravitino.name" . }}-pod-reader
  containers:
      - name: test-container
        image: bitnami/kubectl:latest
        command:
          - "sh"
          - "-c"
          - |
            echo "Checking for running pods in namespace {{ .Release.Namespace }}..."
            running_pods=$(kubectl get pods -n {{ .Release.Namespace }} --field-selector=status.phase=Running -o jsonpath='{.items[*].metadata.name}')
            if [ -z "$running_pods" ]; then
              echo "No running pods found in namespace {{ .Release.Namespace }}."
              exit 1
            else
              echo "Running pods: $running_pods"
              exit 0
            fi
            echo "Checking if metalake_test exists..."
            response=$(curl -s -o /dev/null -w "%{http_code}" http://{{ .Values.service.name }}:8090/api/metalakes/metalake_test)
            if [ "$response" -eq 200 ]; then
            echo "Metalake metalake_test already exists."
            exit 0
            else
            echo "Metalake metalake_test does not exist. Creating..."
            response=$(curl -s -X POST -H "Content-Type: application/json" -d '{"name":"metalake_test","comment":"comment","properties":{}}' http://{{ .Values.service.name }}:8090/api/metalakes)
            if echo "$response" | grep -q "\"code\":0"; then
            echo "Metalake metalake_test created successfully."
            exit 0
            else
            echo "Metalake metalake_test creation failed."
            exit 1
            fi
            fi
        resources:
          requests:
            memory: "64Mi"
            cpu: "250m"
          limits:
            memory: "128Mi"
            cpu: "500m"
  restartPolicy: Never
